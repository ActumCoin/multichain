language: cpp
cache: ccache
deploy:
  provider: releases
  api_key:
    secure: RszdkqCF6DFNJTbY5M4VOwVhGTEPBtmmA09j8WK9OA60Ilwq0OyhWcjAb2GM99N6zT3E2QHqJr6yMOXsd117vs5GjGPEj/WFbPyM2TExJCeJKhoGim2Uvf7GaZCENuYzmntGoN9cHzEAdtAyLeh4YrWOKwoI1RXgbnBWKoC0m+Ko0VhEhdShld243Bage/RwmZuZlP3ki3HSig+KZg2zURHZCayneOuALYVBCvXZtm7I80IDOJ0HlDt0QeMcUQeSEbecQ6HSpWkqT9ZtphmtjzQ9SrTn99PHsvPWmsKp0KmDmRQ1Q9xIblB46jQLuUnVzrkFvniQ5fQ7nBv/wzKfHKI+w+Z2IrmWI3+0HuVzPtsUwb4TymkqFNUAcI8LfJsgKjBxyfWiiL0lm793nEqU40Usi3w8knW9Gfw/IX/j6KVnjqYgl5hF/GoYhgM6U0KO/Kftd6D9gDFLiFEjMwmqbwNurroH1R4xqlCtx2z4VFbmaDqbotHicBx5LcE7p963alQ5AFOpQuTMBDOai4bkLiGXazwBwWW8TdTZ332RvcqlK6zUQAPlZQETbUsForlGchg8fRGDaUud8AntVI0DBtNWLeMN9c78zIja6c/fMLV6UCZQZ3ZP9cpeOo9PAbsmna0jPhDq16uWNd49MqOD+itKtivafmdmg+PAVjyvf0c=
  file_glob: true
  file: "*.tar.gz"
  skip_cleanup: true
  on:
    tags: true
matrix:
  include:
  - os: linux
    sudo: required
    dist: trusty
    before_install:
    - sudo add-apt-repository ppa:bitcoin/bitcoin -y
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake pkg-config
      libssl-dev libevent-dev bsdmainutils libboost-all-dev software-properties-common
      libdb4.8-dev libdb4.8++-dev
    script: "./autogen.sh && ./configure LDFLAGS=-static && make"
    before_deploy: ./prepare-for-deploy.sh false linux-x86_64 "$TRAVIS_TAG"
    env:
    - BUILD_FOR="Linux x86_64"
  - os: linux
    sudo: required
    dist: trusty
    before_install:
    - sudo add-apt-repository ppa:bitcoin/bitcoin -y
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake pkg-config
      libssl-dev libevent-dev bsdmainutils libboost-all-dev software-properties-common
      libdb4.8-dev libdb4.8++-dev g++-arm-linux-gnueabihf curl
    script:
    - "./autogen.sh"
    - cd depends && make HOST=arm-linux-gnueabihf -j4 && cd ..
    - "./configure LDFLAGS=-static --prefix=`pwd`/depends/arm-linux-gnueabihf --enable-cxx --disable-shared
      --enable-static --with-pic"
    - make
    before_deploy: ./prepare-for-deploy.sh false linux-armhf "$TRAVIS_TAG"
    env:
    - BUILD_FOR="Linux armhf"
  - os: linux
    sudo: required
    dist: trusty
    before_install:
    - sudo add-apt-repository ppa:bitcoin/bitcoin -y
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake pkg-config
      libssl-dev libevent-dev bsdmainutils g++-mingw-w64-i686 mingw-w64-i686-dev g++-mingw-w64-x86-64
      mingw-w64-x86-64-dev curl libboost-system-dev libboost-filesystem-dev libboost-chrono-dev
      libboost-program-options-dev libboost-test-dev libboost-thread-dev libdb4.8-dev
      libdb4.8++-dev
    script:
    - "./autogen.sh"
    - cd depends && make HOST=x86_64-w64-mingw32 -j4 && cd ..
    - "./configure --prefix=`pwd`/depends/x86_64-w64-mingw32 --enable-cxx --disable-shared
      --enable-static --with-pic"
    - make
    before_deploy: ./prepare-for-deploy.sh true windows-x86_64 "$TRAVIS_TAG"
    env:
    - BUILD_FOR="Windows x86_64"
  - os: linux
    sudo: required
    dist: trusty
    before_install:
    - sudo add-apt-repository ppa:bitcoin/bitcoin -y
    - sudo apt-get update
    - sudo apt-get install build-essential libtool autotools-dev automake pkg-config
      libssl-dev libevent-dev bsdmainutils g++-mingw-w64-i686 mingw-w64-i686-dev g++-mingw-w64-x86-64
      mingw-w64-x86-64-dev curl libboost-system-dev libboost-filesystem-dev libboost-chrono-dev
      libboost-program-options-dev libboost-test-dev libboost-thread-dev libdb4.8-dev
      libdb4.8++-dev
    script:
    - "./autogen.sh"
    - cd depends && make HOST=i686-w64-mingw32 -j4 && cd ..
    - "./configure --prefix=`pwd`/depends/i686-w64-mingw32 --enable-cxx --disable-shared
      --enable-static --with-pic"
    - make
    before_deploy: ./prepare-for-deploy.sh true windows-x86 "$TRAVIS_TAG"
    env:
    - BUILD_FOR="Windows x86"
  - os: osx
    before_install:
    - brew install autoconf automake berkeley-db4 libtool boost openssl pkg-config rename || true
    - export PATH="/usr/local/opt/ccache/libexec:$PATH"
    - rename -e 's/.dylib/.dylib.hidden/' /usr/local/opt/boost/lib/*.dylib
    - rename -e 's/.dylib/.dylib.hidden/' /usr/local/opt/berkeley-db@4/lib/*.dylib
    - rename -e 's/.dylib/.dylib.hidden/' /usr/local/opt/openssl/lib/*.dylib
    - EDITOR="./mac-openssl-fix.py" brew edit openssl
    - brew install openssl --force
    script:
    - export LDFLAGS=-L/usr/local/opt/openssl/lib
    - export CPPFLAGS=-I/usr/local/opt/openssl/include
    - "./autogen.sh"
    - "./configure --with-gui=no --with-libs=no --with-miniupnpc=no"
    - make
    before_deploy: ./prepare-for-deploy.sh false mac "$TRAVIS_TAG"
    env:
    - BUILD_FOR=Mac
